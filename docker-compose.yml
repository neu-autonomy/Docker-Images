version: '3.3'
services:
  ouster-driver:
    image: ouster:latest
    container_name: ouster-driver
    network_mode: host
    privileged: true
    environment:
      - DISPLAY=${DISPLAY}
    volumes:
      - /dev:/dev
      - /sys:/sys
      - /tmp/.X11-unix:/tmp/.X11-unix
    command: >
      bash -c "source /opt/ros/humble/setup.bash &&
      source /ros2_ws/install/setup.bash &&
      ros2 launch ouster_ros sensor.launch.xml
      sensor_hostname:=169.254.253.236"
    restart: "no"
    
  imu-relay:
    image: dliom:latest
    container_name: imu-relay
    network_mode: host
    depends_on:
      - ouster-driver
    command: >
      bash -c "sleep 15 &&
      source /opt/ros/humble/setup.bash &&
      source /ros2_ws/install/setup.bash &&
      ros2 run topic_tools relay /ouster/imu /ouster/imu_best_effort
      --qos-reliability reliable --qos-durability volatile"
    restart: "no"
    
  pointcloud-relay:
    image: dliom:latest
    container_name: pointcloud-relay
    network_mode: host
    depends_on:
      - ouster-driver
    command: >
      bash -c "sleep 15 &&
      source /opt/ros/humble/setup.bash &&
      source /ros2_ws/install/setup.bash &&
      ros2 run topic_tools relay /ouster/points /ouster/points_best_effort
      --qos-reliability reliable --qos-durability volatile"
    restart: "no"
    
  dliom:
    image: dliom:latest
    container_name: dliom
    network_mode: host
    privileged: true
    environment:
      - DISPLAY=${DISPLAY}
      - XDG_RUNTIME_DIR=/tmp/runtime-root
    volumes:
      - /dev:/dev
      - /sys:/sys
      - /tmp/.X11-unix:/tmp/.X11-unix
    depends_on:
      - imu-relay
      - pointcloud-relay
    command: >
      bash -c '
      sleep 30 &&
      source /opt/ros/humble/setup.bash &&
      source /ros2_ws/install/setup.bash &&
      echo "Starting DLIOM..." &&
      ros2 launch direct_lidar_inertial_odometry_and_mapping dliom.launch.py rviz:=true pointcloud_topic:=/ouster/points_best_effort imu_topic:=/ouster/imu_best_effort'
    restart: "no"
